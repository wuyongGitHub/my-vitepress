"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const r=require("vue"),t=require("../../node_modules/three/build/three.module.js"),te=["innerHTML"],ne=r.defineComponent({name:"JBHeatMap3D",__name:"HeatMap",props:{data:{type:Array,default:()=>[]},width:{type:Number,default:600},height:{type:Number,default:500},baseSize:{type:Number,default:.1},maxHeight:{type:Number,default:3},enableOrbit:{type:Boolean,default:!0},backgroundColor:{type:String,default:"#0d1b2a"},showGridHelper:{type:Boolean,default:!0},showAxesHelper:{type:Boolean,default:!0},isStandardColor:{type:Boolean,default:!0},rotateAnimation:{type:Boolean,default:!1},rotationSpeed:{type:Number,default:.01},gradientColors:{type:Array,default:()=>["#9b30ff","#00ffff","#ffff00","#ff0000"]},autoAnimate:{type:Boolean,default:!1},cameraPosition:{type:Object,default:()=>({x:5,y:5,z:5})}},setup(k,{expose:$}){const N=r.ref(0),n=k,C=r.ref(null),w=r.ref({show:!1,x:0,y:0,content:""}),V=r.ref(n.autoAnimate);let g,M,b,A=null,p,F,L,G=null,z=[],v=0,x=0;r.onMounted(async()=>{const{OrbitControls:o}=await Promise.resolve().then(()=>require("../../node_modules/three/examples/jsm/controls/OrbitControls.js"));J(),n.enableOrbit&&(A=new o(M,b.domElement),A.enableDamping=!0,A.dampingFactor=.05),R(),window.addEventListener("mousemove",T),window.addEventListener("resize",Y),C.value&&C.value.addEventListener("mouseleave",()=>{w.value.show=!1})}),r.onUnmounted(()=>{G&&cancelAnimationFrame(G),window.removeEventListener("mousemove",T),window.removeEventListener("resize",Y),b.dispose()});function J(){const{backgroundColor:o,showGridHelper:e,showAxesHelper:s,cameraPosition:c}=n;g=new t.Scene,g.background=new t.Color(o),M=new t.PerspectiveCamera(75,n.width/n.height,.1,1e3),M.position.set(c.x,c.y,c.z),b=new t.WebGLRenderer({antialias:!0}),b.setSize(n.width,n.height),b.shadowMap.enabled=!0,C.value&&C.value.appendChild(b.domElement),n.enableOrbit&&A&&(A.enableDamping=!0,A.dampingFactor=.05),g.add(new t.AmbientLight(16777215,.6));const a=new t.DirectionalLight(16777215,.8);if(a.position.set(10,20,5),g.add(a),p=new t.Group,g.add(p),e){const d=Math.max(v,x)*n.baseSize*1.2,i=new t.GridHelper(d,Math.max(v,x),4473924,2236962);g.add(i)}if(s){const d=new t.AxesHelper(Math.max(v,x)*n.baseSize*.6);g.add(d)}F=new t.Raycaster,L=new t.Vector2,P()}function U(o=10,e=10){return Array.from({length:o},()=>Array.from({length:e},()=>Math.random()*15+1))}function I(o,e,s,c,a,d){const i=.1+(s-c)/(a-c)*n.maxHeight,u=new t.BoxGeometry(n.baseSize,i,n.baseSize,1,8,1),B=u.attributes.position,E=u.attributes.normal,q=[],h=(s-c)/(a-c),m=[new t.Color(536927),new t.Color(4556987),new t.Color(8765155),new t.Color(12508404),new t.Color(14997468),new t.Color(16572378),new t.Color(16365218),new t.Color(16349280),new t.Color(13112870),new t.Color(11468815)];let l=[],f=0;h>=.9?(f=10,l=m.slice(0,10)):h>=.8?(f=9,l=m.slice(0,9)):h>=.7?(f=8,l=m.slice(0,8)):h>=.6?(f=7,l=m.slice(0,7)):h>=.5?(f=6,l=m.slice(0,6)):h>=.4?(f=5,l=m.slice(0,5)):h>=.3?(f=4,l=m.slice(0,4)):h>=.2?(f=3,l=m.slice(0,3)):h>=.1?(f=2,l=m.slice(0,2)):(f=1,l=m.slice(0,1));for(let D=0;D<B.count;D++){const Q=B.getY(D),Z=E.getY(D);let S=new t.Color;const X=Math.max(0,Math.min(1,(Q+i/2)/i));if(Z>.5)S.copy(l[l.length-1]);else if(f===1)S.copy(l[0]);else{const _=1/(f-1);let y=Math.floor(X/_);y=Math.min(y,f-2),y=Math.max(0,y);const ee=(X-y*_)/_;y>=0&&y+1<l.length?S.lerpColors(l[y],l[y+1],ee):S.copy(l[l.length-1])}q.push(S.r,S.g,S.b)}u.setAttribute("color",new t.BufferAttribute(new Float32Array(q),3));const K=new t.MeshBasicMaterial({vertexColors:!0}),O=new t.Mesh(u,K);return O.position.set((o-(v-1)/2)*n.baseSize,i/2,(e-(x-1)/2)*n.baseSize),O.userData={value:s,x:o,z:e},O}let H=null;new t.Object3D;function W(){if(H)H.geometry.dispose(),H.material.dispose(),p.remove(H),H=null;else{const{children:o}=p;o.forEach(e=>{e instanceof t.Mesh&&(e.geometry.dispose(),(Array.isArray(e.material)?e.material:[e.material]).forEach(c=>c.dispose()))}),p.clear()}}function P(){var c;if(W(),Array.isArray(n.data)&&n.data.length>0&&n.data.every(a=>Array.isArray(a))?z=n.data.map(a=>[...a]):(console.log("数据不合法，使用默认数据"),z=U()),p.clear(),v=z.length,x=((c=z[0])==null?void 0:c.length)||0,v===0||x===0){console.warn("数据为空，无法创建热力图");return}let e=1/0,s=-1/0;for(let a=0;a<v;a++){const d=z[a];if(Array.isArray(d))for(let i=0;i<x;i++){const u=d[i];typeof u=="number"&&(u<e&&(e=u),u>s&&(s=u))}}e===1/0&&(e=0),s===-1/0&&(s=0);for(let a=0;a<v;a++){const d=z[a];if(Array.isArray(d))for(let i=0;i<x;i++){const u=d[i],B=typeof u=="number"?u:0;let E=null;n.isStandardColor,E=I(a,i,B,e,s),p.add(E)}}}function R(){G=requestAnimationFrame(R),n.rotateAnimation&&(N.value+=n.rotationSpeed,p.rotation.y=N.value),A&&A.update(),b.render(g,M)}let j=null;function T(o){if(!C.value)return;const e=C.value.getBoundingClientRect();if(o.clientX<e.left||o.clientX>e.right||o.clientY<e.top||o.clientY>e.bottom){w.value.show=!1;return}j&&cancelAnimationFrame(j),j=requestAnimationFrame(()=>{L.x=(o.clientX-e.left)/e.width*2-1,L.y=-((o.clientY-e.top)/e.height)*2+1,F.setFromCamera(L,M);const s=F.intersectObjects(p.children);if(s.length){const c=s[0].object,{value:a,x:d,z:i}=c.userData;w.value={show:!0,x:o.clientX-e.left+10,y:o.clientY-e.top-30,content:`数值: ${a.toFixed(2)}<br>位置: (${d}, ${i})`}}else w.value.show=!1})}function Y(){M.aspect=n.width/n.height,M.updateProjectionMatrix(),b.setSize(n.width,n.height)}return $({refresh:P,toggleAnimation:()=>V.value=!V.value}),(o,e)=>(r.openBlock(),r.createElementBlock("div",{class:"heatmap-wrapper",style:r.normalizeStyle({width:k.width+"px",height:k.height+"px"})},[r.unref(w).show?(r.openBlock(),r.createElementBlock("div",{key:0,class:"tooltip",style:r.normalizeStyle({left:r.unref(w).x+"px",top:r.unref(w).y+"px"}),innerHTML:r.unref(w).content},null,12,te)):r.createCommentVNode("",!0),r.createElementVNode("div",{ref_key:"containerRef",ref:C,class:"three-container"},null,512)],4))}});exports.default=ne;

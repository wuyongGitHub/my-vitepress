"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const i=require("vue"),a=require("../../node_modules/three/build/three.module.js"),K=["innerHTML"],Q=i.defineComponent({name:"JBHeatMap3D",__name:"HeatMap",props:{data:{type:Array,default:()=>[]},width:{type:Number,default:600},height:{type:Number,default:500},baseSize:{type:Number,default:.1},maxHeight:{type:Number,default:3},enableOrbit:{type:Boolean,default:!0},backgroundColor:{type:String,default:"#0d1b2a"},showGridHelper:{type:Boolean,default:!0},showAxesHelper:{type:Boolean,default:!0},gradientColors:{type:Array,default:()=>["#9b30ff","#00ffff","#ffff00","#ff0000"]},autoAnimate:{type:Boolean,default:!1},cameraPosition:{type:Object,default:()=>({x:5,y:5,z:5})}},setup(E,{expose:Y}){const o=E,x=i.ref(null),w=i.ref({show:!1,x:0,y:0,content:""}),B=i.ref(o.autoAnimate);let g,C,b,v=null,A,D,z,L=null,p=[],h=0,y=0;i.onMounted(async()=>{const{OrbitControls:t}=await Promise.resolve().then(()=>require("../../node_modules/three/examples/jsm/controls/OrbitControls.js"));q(),o.enableOrbit&&(v=new t(C,b.domElement),v.enableDamping=!0,v.dampingFactor=.05),V(),window.addEventListener("mousemove",N),window.addEventListener("resize",P),x.value&&x.value.addEventListener("mouseleave",()=>{w.value.show=!1})}),i.onUnmounted(()=>{L&&cancelAnimationFrame(L),window.removeEventListener("mousemove",N),window.removeEventListener("resize",P),b.dispose()});function q(){const{backgroundColor:t,showGridHelper:e,showAxesHelper:s,cameraPosition:c}=o;g=new a.Scene,g.background=new a.Color(t),C=new a.PerspectiveCamera(75,o.width/o.height,.1,1e3),C.position.set(c.x,c.y,c.z),b=new a.WebGLRenderer({antialias:!0}),b.setSize(o.width,o.height),b.shadowMap.enabled=!0,x.value&&x.value.appendChild(b.domElement),o.enableOrbit&&v&&(v.enableDamping=!0,v.dampingFactor=.05),g.add(new a.AmbientLight(16777215,.6));const r=new a.DirectionalLight(16777215,.8);if(r.position.set(10,20,5),g.add(r),A=new a.Group,g.add(A),e){const d=Math.max(h,y)*o.baseSize*1.2,l=new a.GridHelper(d,Math.max(h,y),4473924,2236962);g.add(l)}if(s){const d=new a.AxesHelper(Math.max(h,y)*o.baseSize*.6);g.add(d)}D=new a.Raycaster,z=new a.Vector2,_()}function I(t=10,e=10){return Array.from({length:t},()=>Array.from({length:e},()=>Math.random()*15+1))}function T(t,e,s,c,r,d){const l=.1+(s-c)/(r-c)*o.maxHeight,f=new a.BoxGeometry(o.baseSize,l,o.baseSize,1,8,1),k=f.attributes.position,F=f.attributes.normal,R=[],G=(s-c)/(r-c),H=[new a.Color(139),new a.Color(65535),new a.Color(16776960),new a.Color(16711680)];let n=[];G>=.75?n=[...H]:G>=.5?n=H.slice(0,3):G>=.25?n=H.slice(0,2):n=H.slice(0,1);for(let S=0;S<k.count;S++){const U=k.getY(S),W=F.getY(S);let u=new a.Color;const m=(U+l/2)/l;W>.5?u.copy(n[n.length-1]):n.length===4?m<.25?u.lerpColors(n[0],n[1],m/.25):m<.5?u.lerpColors(n[1],n[2],(m-.25)/.25):m<.75?u.lerpColors(n[2],n[3],(m-.5)/.25):u.copy(n[3]):n.length===3?m<.33?u.lerpColors(n[0],n[1],m/.33):m<.66?u.lerpColors(n[1],n[2],(m-.33)/.33):u.copy(n[2]):n.length===2?m<.5?u.lerpColors(n[0],n[1],m/.5):u.copy(n[1]):u.copy(n[0]),R.push(u.r,u.g,u.b)}f.setAttribute("color",new a.BufferAttribute(new Float32Array(R),3));const J=new a.MeshBasicMaterial({vertexColors:!0}),O=new a.Mesh(f,J);return O.position.set((t-(h-1)/2)*o.baseSize,l/2,(e-(y-1)/2)*o.baseSize),O.userData={value:s,x:t,z:e},O}let M=null;new a.Object3D;function X(){if(M)M.geometry.dispose(),M.material.dispose(),A.remove(M),M=null;else{const{children:t}=A;t.forEach(e=>{e instanceof a.Mesh&&(e.geometry.dispose(),(Array.isArray(e.material)?e.material:[e.material]).forEach(c=>c.dispose()))}),A.clear()}}function _(){var c;if(X(),console.log("createHeatmap 调用，props.data =",o.data),Array.isArray(o.data)&&o.data.length>0&&o.data.every(r=>Array.isArray(r))?p=o.data:(console.log("数据不合法，使用默认数据"),p=I()),A.clear(),h=p.length,y=((c=p[0])==null?void 0:c.length)||0,h===0||y===0){console.warn("数据为空，无法创建热力图");return}let e=1/0,s=-1/0;for(let r=0;r<h;r++){const d=p[r];if(Array.isArray(d))for(let l=0;l<y;l++){const f=d[l];typeof f=="number"&&(f<e&&(e=f),f>s&&(s=f))}}e===1/0&&(e=0),s===-1/0&&(s=0);for(let r=0;r<h;r++){const d=p[r];if(Array.isArray(d))for(let l=0;l<y;l++){const f=d[l],F=T(r,l,typeof f=="number"?f:0,e,s);A.add(F)}}}function V(){L=requestAnimationFrame(V),B.value&&$(),v&&v.update(),b.render(g,C)}function $(){for(let t=0;t<h;t++)for(let e=0;e<y;e++)p[t]&&typeof p[t][e]=="number"&&(p[t][e]+=(Math.random()-.5)*.3,p[t][e]=Math.min(20,Math.max(1,p[t][e])))}let j=null;function N(t){if(!x.value)return;const e=x.value.getBoundingClientRect();if(t.clientX<e.left||t.clientX>e.right||t.clientY<e.top||t.clientY>e.bottom){w.value.show=!1;return}j&&cancelAnimationFrame(j),j=requestAnimationFrame(()=>{z.x=(t.clientX-e.left)/e.width*2-1,z.y=-((t.clientY-e.top)/e.height)*2+1,D.setFromCamera(z,C);const s=D.intersectObjects(A.children);if(s.length){const c=s[0].object,{value:r,x:d,z:l}=c.userData;w.value={show:!0,x:t.clientX-e.left+10,y:t.clientY-e.top-30,content:`数值: ${r.toFixed(2)}<br>位置: (${d}, ${l})`}}else w.value.show=!1})}function P(){C.aspect=o.width/o.height,C.updateProjectionMatrix(),b.setSize(o.width,o.height)}return Y({refresh:_,toggleAnimation:()=>B.value=!B.value}),(t,e)=>(i.openBlock(),i.createElementBlock("div",{class:"heatmap-wrapper",style:i.normalizeStyle({width:E.width+"px",height:E.height+"px"})},[i.unref(w).show?(i.openBlock(),i.createElementBlock("div",{key:0,class:"tooltip",style:i.normalizeStyle({left:i.unref(w).x+"px",top:i.unref(w).y+"px"}),innerHTML:i.unref(w).content},null,12,K)):i.createCommentVNode("",!0),i.createElementVNode("div",{ref_key:"containerRef",ref:x,class:"three-container"},null,512)],4))}});exports.default=Q;
